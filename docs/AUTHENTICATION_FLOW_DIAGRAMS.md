# Microsoft Entra External ID - Authentication Flow Diagrams

Visual reference for understanding how authentication works in the Cardea platform.

---

## ğŸ“Š Overall Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Cardea Platform                              â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚   Frontend   â”‚           â”‚   Backend    â”‚                        â”‚
â”‚  â”‚   (React)    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (FastAPI)   â”‚                        â”‚
â”‚  â”‚              â”‚           â”‚              â”‚                        â”‚
â”‚  â”‚  MSAL.js     â”‚           â”‚  MSAL Python â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚         â”‚                          â”‚                                â”‚
â”‚         â”‚ Access Token             â”‚ Validates Token                â”‚
â”‚         â”‚                          â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                          â”‚
          â”‚                          â”‚
          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Microsoft Entra ID                                 â”‚
â”‚             (Azure Active Directory / Entra External ID)             â”‚
â”‚                                                                       â”‚
â”‚  â€¢ User Authentication                                               â”‚
â”‚  â€¢ Token Issuance                                                    â”‚
â”‚  â€¢ Public Keys (JWKS)                                                â”‚
â”‚  â€¢ User Profile (via Graph API)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ User Data
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PostgreSQL Database                              â”‚
â”‚                                                                       â”‚
â”‚  users table:                                                        â”‚
â”‚  â”œâ”€ id                                                               â”‚
â”‚  â”œâ”€ username                                                         â”‚
â”‚  â”œâ”€ email                                                            â”‚
â”‚  â”œâ”€ azure_oid  â—„â”€â”€ Azure Object ID (unique identifier)              â”‚
â”‚  â”œâ”€ full_name                                                        â”‚
â”‚  â”œâ”€ roles                                                            â”‚
â”‚  â””â”€ last_login                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Authentication Flow (First-Time Login)

```
â”Œâ”€â”€â”€â”€â”€â”                                                                  
â”‚User â”‚                                                                  
â””â”€â”€â”¬â”€â”€â”˜                                                                  
   â”‚                                                                     
   â”‚ 1. Opens http://localhost:5173                                     
   â–¼                                                                     
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        
â”‚ Login Page   â”‚                                                        
â”‚              â”‚                                                        
â”‚ [Email/Pass] â”‚                                                        
â”‚              â”‚                                                        
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                                        
â”‚ â”‚Microsoft â”‚ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. User clicks this button                 
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                                        
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                        
       â”‚                                                                
       â”‚ 3. Redirect to Microsoft                                      
       â”‚    (with client_id, redirect_uri, scopes)                     
       â–¼                                                                
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     
â”‚   Microsoft Entra ID Login Page                â”‚                     
â”‚   login.microsoftonline.com                    â”‚                     
â”‚                                                 â”‚                     
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                     
â”‚   â”‚  Email: user@company.com                â”‚  â”‚                     
â”‚   â”‚  Password: **********                   â”‚  â”‚â—„â”€â”€â”€ 4. User enters credentials
â”‚   â”‚                                         â”‚  â”‚                     
â”‚   â”‚  [Sign In]                              â”‚  â”‚                     
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                     
â”‚                                                 â”‚                     
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                     
â”‚   â”‚ Permissions requested:                  â”‚  â”‚                     
â”‚   â”‚ â€¢ Read your profile (User.Read)         â”‚  â”‚â—„â”€â”€â”€ 5. User consents
â”‚   â”‚                                         â”‚  â”‚       (first time only)
â”‚   â”‚ [Accept]                                â”‚  â”‚                     
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                     
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     
                 â”‚                                                      
                 â”‚ 6. Generates tokens:                                
                 â”‚    â€¢ ID Token (user info)                           
                 â”‚    â€¢ Access Token (API access)                      
                 â”‚                                                      
                 â”‚ 7. Redirect back to app                             
                 â”‚    http://localhost:5173?code=...                   
                 â–¼                                                      
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           
â”‚  React App (MSAL.js)                     â”‚                           
â”‚                                           â”‚                           
â”‚  8. Receives authorization code           â”‚                           
â”‚  9. Exchanges code for tokens             â”‚                           
â”‚  10. Stores tokens in session             â”‚                           
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           
               â”‚                                                        
               â”‚ 11. Call backend API                                  
               â”‚     Authorization: Bearer <access_token>              
               â–¼                                                        
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         
â”‚  Oracle Backend (FastAPI)                  â”‚                         
â”‚                                             â”‚                         
â”‚  12. Receives request with token           â”‚                         
â”‚  13. Validates token:                      â”‚                         
â”‚      â€¢ Fetch JWKS from Microsoft           â”‚â—„â”€â”€â”€â”€â”                   
â”‚      â€¢ Verify signature                    â”‚     â”‚ 14. Get public    
â”‚      â€¢ Check expiration                    â”‚     â”‚     keys (JWKS)   
â”‚      â€¢ Verify issuer & audience            â”‚     â”‚                   
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                   
                 â”‚                                 â”‚                   
                 â”‚                                 â”‚                   
            â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        
            â”‚ Valid?  â”‚                    â”‚ Microsoft Entra  â”‚        
            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â”‚ .well-known/     â”‚        
                 â”‚                         â”‚ jwks_uri         â”‚        
                 â”‚ Yes                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        
                 â–¼                                                      
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         
â”‚  Create/Update User in Database            â”‚                         
â”‚                                             â”‚                         
â”‚  15. Extract from token:                   â”‚                         
â”‚      â€¢ email                                â”‚                         
â”‚      â€¢ name                                 â”‚                         
â”‚      â€¢ oid (Azure Object ID)                â”‚                         
â”‚                                             â”‚                         
â”‚  16. Check if user exists                  â”‚                         
â”‚      (by azure_oid or email)                â”‚                         
â”‚                                             â”‚                         
â”‚  17. Create new user OR update existing    â”‚                         
â”‚                                             â”‚                         
â”‚  18. Set last_login = now()                â”‚                         
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         
                 â”‚                                                      
                 â”‚ 19. Return user data                                
                 â–¼                                                      
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         
â”‚  Frontend receives user data               â”‚                         
â”‚                                             â”‚                         
â”‚  20. Set auth state to authenticated       â”‚                         
â”‚  21. Navigate to /dashboard                â”‚                         
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         
                 â”‚                                                      
                 â–¼                                                      
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         
â”‚  Dashboard Page                            â”‚                         
â”‚                                             â”‚                         
â”‚  âœ… User is logged in!                     â”‚                         
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         
```

---

## ğŸ”„ Subsequent Logins (Token Still Valid)

```
â”Œâ”€â”€â”€â”€â”€â”
â”‚User â”‚
â””â”€â”€â”¬â”€â”€â”˜
   â”‚ 1. Opens app
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  React App       â”‚
â”‚  (MSAL.js)       â”‚
â”‚                  â”‚
â”‚  2. Check cache  â”‚â—„â”€â”€â”€â”€ Token stored in sessionStorage
â”‚     for token    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ 3. Token exists & not expired
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redirect to     â”‚
â”‚  /dashboard      â”‚
â”‚                  â”‚
â”‚  âœ… Auto-login!  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ Token Validation Process (Backend)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Request                                       â”‚
â”‚  GET /api/analytics                                â”‚
â”‚  Authorization: Bearer eyJ0eXAiOiJKV1QiLCJh...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Extract Token from Authorization header        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Decode Header (without verification)           â”‚
â”‚     {                                              â”‚
â”‚       "typ": "JWT",                                â”‚
â”‚       "alg": "RS256",                              â”‚
â”‚       "kid": "abc123..."  â—„â”€â”€ Key ID               â”‚
â”‚     }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Fetch JWKS (JSON Web Key Set)                 â”‚
â”‚     from Microsoft Entra ID                        â”‚
â”‚                                                    â”‚
â”‚     GET https://login.microsoftonline.com/         â”‚
â”‚         {tenant}/discovery/v2.0/keys               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Returns:
                 â”‚ {
                 â”‚   "keys": [
                 â”‚     {
                 â”‚       "kid": "abc123...",
                 â”‚       "kty": "RSA",
                 â”‚       "n": "public key modulus",
                 â”‚       "e": "public key exponent"
                 â”‚     }
                 â”‚   ]
                 â”‚ }
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Find Matching Public Key                      â”‚
â”‚     (match "kid" from token header)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Verify Token Signature                        â”‚
â”‚     Using RSA public key                          â”‚
â”‚                                                    â”‚
â”‚     â€¢ Decode payload                               â”‚
â”‚     â€¢ Verify signature matches                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Validate Token Claims                         â”‚
â”‚                                                    â”‚
â”‚     âœ“ iss (issuer):                                â”‚
â”‚       https://login.microsoftonline.com/{tenant}/v2.0
â”‚                                                    â”‚
â”‚     âœ“ aud (audience):                              â”‚
â”‚       {your_client_id}                             â”‚
â”‚                                                    â”‚
â”‚     âœ“ exp (expiration):                            â”‚
â”‚       Must be in the future                        â”‚
â”‚                                                    â”‚
â”‚     âœ“ nbf (not before):                            â”‚
â”‚       Must be in the past                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”œâ”€â”€â–º âŒ Invalid â†’ Return 401 Unauthorized
                 â”‚
                 â””â”€â”€â–º âœ… Valid
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. Extract User Information                      â”‚
â”‚     {                                              â”‚
â”‚       "oid": "abc-123-def",    â—„â”€â”€ Azure Object ID â”‚
â”‚       "email": "user@company.com",                 â”‚
â”‚       "name": "John Doe",                          â”‚
â”‚       "preferred_username": "john@company.com"     â”‚
â”‚     }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. Load/Create User from Database                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. Process API Request                           â”‚
â”‚     (User is authenticated!)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ Code Flow Through Files

### Frontend Flow

```
main.tsx
  â”‚
  â”œâ”€â–º Initialize MSAL instance
  â”‚   â””â”€â–º authConfig.ts (configuration)
  â”‚
  â”œâ”€â–º Wrap app with MsalProvider
  â”‚
  â””â”€â–º Wrap app with AuthProvider
      â”‚
      â””â”€â–º contexts/AuthContext.tsx
          â”‚
          â”œâ”€â–º login() â†’ Redirect to Microsoft
          â”œâ”€â–º logout() â†’ Clear session
          â””â”€â–º getAccessToken() â†’ Get token for API calls
              â”‚
              â””â”€â–º Used by components to call backend


LoginPage.tsx
  â”‚
  â”œâ”€â–º useAuth() hook
  â”‚   â””â”€â–º contexts/AuthContext.tsx
  â”‚
  â””â”€â–º handleMicrosoftSignIn()
      â”‚
      â””â”€â–º login() â†’ Redirect to Microsoft


App.tsx (Dashboard)
  â”‚
  â”œâ”€â–º useAuth() hook (check if authenticated)
  â”‚
  â””â”€â–º Make API calls with token
      â”‚
      â””â”€â–º axios.get('/api/analytics', {
            headers: { Authorization: `Bearer ${token}` }
          })
```

### Backend Flow

```
main.py
  â”‚
  â””â”€â–º Import azure_auth.py


azure_auth.py
  â”‚
  â”œâ”€â–º Class: AzureAuthService
  â”‚   â”‚
  â”‚   â”œâ”€â–º validate_azure_token(token)
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â–º Fetch JWKS from Microsoft
  â”‚   â”‚   â”œâ”€â–º Verify signature
  â”‚   â”‚   â”œâ”€â–º Validate claims
  â”‚   â”‚   â””â”€â–º Return decoded payload
  â”‚   â”‚
  â”‚   â””â”€â–º create_or_update_user_from_azure(payload)
  â”‚       â”‚
  â”‚       â”œâ”€â–º Extract user info
  â”‚       â”œâ”€â–º Query database
  â”‚       â”œâ”€â–º Create or update user
  â”‚       â””â”€â–º Return User object
  â”‚
  â””â”€â–º Dependency: get_current_user_from_azure_token
      â”‚
      â””â”€â–º Used in API routes:
          @app.get("/api/protected")
          async def protected(user: User = Depends(get_current_user_from_azure_token)):
              # User is authenticated here
```

---

## ğŸ—‚ï¸ Database Schema

```sql
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  users table                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                SERIAL PRIMARY KEY             â”‚
â”‚ username          VARCHAR(255) UNIQUE NOT NULL   â”‚
â”‚ email             VARCHAR(255) UNIQUE NOT NULL   â”‚
â”‚ full_name         VARCHAR(255)                   â”‚
â”‚ hashed_password   VARCHAR(255)  â—„â”€â”€ NULL for SSO â”‚
â”‚ azure_oid         VARCHAR(255) UNIQUE â—„â”€â”€ NEW!   â”‚
â”‚ roles             TEXT[] DEFAULT ARRAY['user']   â”‚
â”‚ is_active         BOOLEAN DEFAULT TRUE           â”‚
â”‚ created_at        TIMESTAMP DEFAULT NOW()        â”‚
â”‚ last_login        TIMESTAMP                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Indexes:
         â”‚
         â”œâ”€â–º idx_users_email ON email
         â”œâ”€â–º idx_users_username ON username
         â””â”€â–º idx_users_azure_oid ON azure_oid  â—„â”€â”€ NEW!
```

**Key Changes:**
- Added `azure_oid` column to store Azure Object ID (unique identifier)
- Made `hashed_password` nullable (SSO users don't need local password)
- Added index on `azure_oid` for fast lookups

---

## ğŸ”’ Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: HTTPS (Production)                                â”‚
â”‚  â””â”€â–º All communication encrypted in transit                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: OAuth 2.0 / OpenID Connect                       â”‚
â”‚  â””â”€â–º Industry-standard authentication protocol             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: JWT Token with RS256 Signature                   â”‚
â”‚  â””â”€â–º Tokens signed by Microsoft's private key              â”‚
â”‚  â””â”€â–º Verified with Microsoft's public key                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: Token Validation                                 â”‚
â”‚  â”œâ”€â–º Signature verification                                 â”‚
â”‚  â”œâ”€â–º Expiration check                                       â”‚
â”‚  â”œâ”€â–º Issuer verification                                    â”‚
â”‚  â””â”€â–º Audience verification                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 5: User Authorization                               â”‚
â”‚  â”œâ”€â–º Role-based access control (RBAC)                       â”‚
â”‚  â””â”€â–º Check user has required roles                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 6: API Rate Limiting (Recommended)                  â”‚
â”‚  â””â”€â–º Prevent abuse and DoS attacks                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ Environment Variables Flow

```
Azure Portal
  â”‚
  â”œâ”€â–º Application (client) ID
  â”œâ”€â–º Directory (tenant) ID
  â””â”€â–º Client Secret
      â”‚
      â”‚ Copy to:
      â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                             â”‚                              â”‚
      â–¼                             â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ .env         â”‚          â”‚ dashboard/.env   â”‚        â”‚ Production       â”‚
â”‚ (Backend)    â”‚          â”‚ (Frontend)       â”‚        â”‚ Environment      â”‚
â”‚              â”‚          â”‚                  â”‚        â”‚ Variables        â”‚
â”‚ AZURE_       â”‚          â”‚ VITE_AZURE_      â”‚        â”‚ (Azure App       â”‚
â”‚ TENANT_ID    â”‚          â”‚ CLIENT_ID        â”‚        â”‚  Service, etc.)  â”‚
â”‚              â”‚          â”‚                  â”‚        â”‚                  â”‚
â”‚ AZURE_       â”‚          â”‚ VITE_AZURE_      â”‚        â”‚                  â”‚
â”‚ CLIENT_ID    â”‚          â”‚ TENANT_ID        â”‚        â”‚                  â”‚
â”‚              â”‚          â”‚                  â”‚        â”‚                  â”‚
â”‚ AZURE_       â”‚          â”‚ VITE_API_SCOPES  â”‚        â”‚                  â”‚
â”‚ CLIENT_SECRETâ”‚          â”‚                  â”‚        â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                           â”‚                           â”‚
       â”‚ Read by                   â”‚ Read by                   â”‚ Read by
       â”‚                           â”‚                           â”‚
       â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ config.py    â”‚          â”‚ authConfig.ts    â”‚        â”‚ CI/CD Pipeline   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“± User Experience Flow

```
User Journey
â•â•â•â•â•â•â•â•â•â•â•

1. User â†’ "I want to access the dashboard"
          â”‚
          â–¼
2. App  â†’ "Let me check if you're logged in..."
          â”‚
          â”œâ”€â–º âœ… Token exists â†’ Skip to step 7
          â”‚
          â””â”€â–º âŒ Not logged in
              â”‚
              â–¼
3. App  â†’ "Please sign in"
          [Show Login Page with Microsoft button]
          â”‚
          â–¼
4. User â†’ [Clicks Microsoft button]
          â”‚
          â–¼
5. App  â†’ Redirect to Microsoft login
          â”‚
          â–¼
6. Microsoft â†’ "Who are you?"
               [User signs in]
               â”‚
               â”œâ”€â–º First time: "This app wants to access your profile. OK?"
               â”‚                [User consents]
               â”‚
               â””â”€â–º Subsequent: [Auto-approved]
                   â”‚
                   â–¼
7. Microsoft â†’ "Here's your token"
               Redirect back to app
               â”‚
               â–¼
8. App  â†’ "Token received! Creating your account..."
          [Backend creates user if new]
          â”‚
          â–¼
9. App  â†’ "Welcome! Here's your dashboard"
          [Show dashboard with user's name]
          â”‚
          â–¼
10. User â†’ âœ… Accessing protected resources
            All API calls include token automatically
```

---

## ğŸ¯ Quick Reference: What Happens Where

| Component | Responsibility |
|-----------|---------------|
| **Azure Portal** | User authentication, token issuance, public keys |
| **MSAL.js (Frontend)** | Handle OAuth flow, store tokens, refresh tokens |
| **React Auth Context** | Manage auth state, provide auth methods to components |
| **LoginPage** | Display UI, trigger Microsoft sign-in |
| **FastAPI Backend** | Validate tokens, create/update users, protect APIs |
| **azure_auth.py** | Token validation logic, user provisioning |
| **PostgreSQL** | Store user data, roles, last login |

---

## ğŸ“Š Token Lifecycle

```
Token Creation â†’ Token Use â†’ Token Expiration â†’ Token Renewal
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Creation (Microsoft Entra ID)
   â”œâ”€â–º Access Token: 1 hour expiration
   â”œâ”€â–º ID Token: Contains user info
   â””â”€â–º Refresh Token: Long-lived (optional)

2. Storage (Frontend)
   â”œâ”€â–º sessionStorage (recommended)
   â””â”€â–º Memory (MSAL.js handles this)

3. Use (API Calls)
   â”œâ”€â–º Include in Authorization header
   â””â”€â–º Backend validates on each request

4. Expiration Check
   â”œâ”€â–º Frontend: MSAL.js checks expiration
   â””â”€â–º Backend: JWT library checks expiration

5. Renewal (Silent)
   â”œâ”€â–º MSAL.js: acquireTokenSilent()
   â”œâ”€â–º Uses refresh token if available
   â”œâ”€â–º Or uses hidden iframe
   â””â”€â–º Gets new access token automatically

6. Re-authentication (If Renewal Fails)
   â””â”€â–º Redirect to Microsoft login again
```

---

These diagrams should help you understand how everything connects!

For implementation details, see:
- [Quick Start Guide](./QUICKSTART_ENTRA.md)
- [Complete Setup](./MICROSOFT_ENTRA_SETUP.md)
- [Azure Checklist](./AZURE_PORTAL_CHECKLIST.md)
